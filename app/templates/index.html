<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Taxi Prediction AI</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f0f2f5;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        .container {
            display: flex;
            width: 100%;
            max-width: 1000px; 
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            flex-direction: column;
        }
        @media (min-width: 768px) {
            .container { flex-direction: row; }
        }

        .form-section {
            padding: 30px;
            flex: 1;
            background: white;
            z-index: 2;
        }

        .map-section {
            flex: 1.5;
            min-height: 400px;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }

        h1 { color: #2c3e50; margin-bottom: 20px; font-size: 24px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 0.9em;}
        input, select {
            width: 100%; padding: 10px;
            border: 1px solid #ddd; border-radius: 6px;
        }
        
        button {
            width: 100%; padding: 12px;
            background: #3498db; color: white;
            border: none; border-radius: 6px;
            font-weight: bold; cursor: pointer;
            margin-top: 10px; transition: 0.3s;
        }
        button:hover { background: #2980b9; }

        .result-box {
            margin-top: 20px; padding: 15px;
            background: #e8f6f3; border-radius: 8px;
            border-left: 4px solid #1abc9c;
            display: none;
        }
        .result-box.show { display: block; animation: fadeIn 0.5s; }
        .error-box {
            margin-top: 20px; padding: 15px;
            background: #fdeaea; border-radius: 8px;
            border-left: 4px solid #e74c3c; color: #c0392b;
            display: none;
        }

        .marker-label { font-weight: bold; color: #333; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="form-section">
        <h1>üöñ NYC Taxi AI</h1>
        <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">K√©o th·∫£ ghim tr√™n b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒëi/ƒë·∫øn.</p>

        <form id="predictionForm">
            <div class="form-group">
                <label>Th·ªùi gian kh·ªüi h√†nh</label>
                <input type="datetime-local" name="pickup_datetime" required>
            </div>

            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex:1">
                    <label>H√£ng xe</label>
                    <select name="vendor_id">
                        <option value="1">Creative Mobile</option>
                        <option value="2" selected>VeriFone</option>
                    </select>
                </div>
                <div style="flex:1">
                    <label>S·ªë kh√°ch</label>
                    <input type="number" name="passenger_count" min="1" max="6" value="1">
                </div>
            </div>

            <input type="hidden" id="p_lat" name="pickup_latitude" value="40.7614">
            <input type="hidden" id="p_lon" name="pickup_longitude" value="-73.9776">
            <input type="hidden" id="d_lat" name="dropoff_latitude" value="40.7500">
            <input type="hidden" id="d_lon" name="dropoff_longitude" value="-73.9900">

            <button type="submit">üöÄ D·ª± ƒëo√°n ngay</button>
        </form>

        <div id="loading" style="display:none; text-align:center; margin-top:10px;">‚è≥ ƒêang t√≠nh to√°n...</div>
        
        <div class="result-box" id="result">
            <h3 style="color:#16a085; margin-bottom:5px;">K·∫øt qu·∫£ d·ª± b√°o:</h3>
            <p style="font-size: 1.2em; font-weight: bold;" id="time_text">-- ph√∫t</p>
            <div style="margin-top: 10px; font-size: 0.9em; color: #555;">
                <p>üìè Qu√£ng ƒë∆∞·ªùng: <span id="dist_text">--</span> km</p>
                <p>üö¶ Gi·ªù cao ƒëi·ªÉm: <span id="rush_text">--</span></p>
            </div>
        </div>

        <div class="error-box" id="error"></div>
    </div>

    <div class="map-section">
        <div id="map"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // --- C·∫§U H√åNH B·∫¢N ƒê·ªí ---
    // T·ªça ƒë·ªô trung t√¢m NYC
    const NYC_CENTER = [40.7580, -73.9855];
    
    // Kh·ªüi t·∫°o map
    const map = L.map('map').setView(NYC_CENTER, 13);

    // Th√™m l·ªõp g·∫°ch b·∫£n ƒë·ªì (OpenStreetMap - Mi·ªÖn ph√≠)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // T·∫°o Icon t√πy ch·ªânh (Xanh cho ƒêi·ªÉm ƒë√≥n, ƒê·ªè cho ƒêi·ªÉm tr·∫£)
    // D√πng filter CSS ƒë·ªÉ ƒë·ªïi m√†u icon m·∫∑c ƒë·ªãnh
    const pickupIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/markers/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    const dropoffIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/markers/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    // L·∫•y gi√° tr·ªã m·∫∑c ƒë·ªãnh t·ª´ input hidden
    let pLat = parseFloat(document.getElementById('p_lat').value);
    let pLon = parseFloat(document.getElementById('p_lon').value);
    let dLat = parseFloat(document.getElementById('d_lat').value);
    let dLon = parseFloat(document.getElementById('d_lon').value);

    const pickupMarker = L.marker([pLat, pLon], {icon: pickupIcon, draggable: true}).addTo(map).bindPopup("ƒêi·ªÉm ƒë√≥n (K√©o t√¥i!)").openPopup();
    const dropoffMarker = L.marker([dLat, dLon], {icon: dropoffIcon, draggable: true}).addTo(map).bindPopup("ƒêi·ªÉm tr·∫£ (K√©o t√¥i!)");

    function updateInputs() {
        const pPos = pickupMarker.getLatLng();
        const dPos = dropoffMarker.getLatLng();

        document.getElementById('p_lat').value = pPos.lat.toFixed(6);
        document.getElementById('p_lon').value = pPos.lng.toFixed(6);
        document.getElementById('d_lat').value = dPos.lat.toFixed(6);
        document.getElementById('d_lon').value = dPos.lng.toFixed(6);
    }


    pickupMarker.on('dragend', updateInputs);
    dropoffMarker.on('dragend', updateInputs);

    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.querySelector('input[name="pickup_datetime"]').value = now.toISOString().slice(0, 16);

    document.getElementById('predictionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const resultBox = document.getElementById('result');
        const errorBox = document.getElementById('error');
        const loading = document.getElementById('loading');

        resultBox.classList.remove('show');
        errorBox.style.display = 'none';
        loading.style.display = 'block';

        const formData = new FormData(e.target);
        const data = {
            vendor_id: parseInt(formData.get('vendor_id')),
            pickup_datetime: formData.get('pickup_datetime').replace('T', ' ') + ':00',
            passenger_count: parseInt(formData.get('passenger_count')),
            // L·∫•y t·ªça ƒë·ªô t·ª´ hidden input (ƒë√£ ƒë∆∞·ª£c map c·∫≠p nh·∫≠t)
            pickup_longitude: parseFloat(formData.get('pickup_longitude')),
            pickup_latitude: parseFloat(formData.get('pickup_latitude')),
            dropoff_longitude: parseFloat(formData.get('dropoff_longitude')),
            dropoff_latitude: parseFloat(formData.get('dropoff_latitude')),
            store_and_fwd_flag: 'N'
        };

        try {
            const response = await fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            loading.style.display = 'none';

            if (result.success) {
                document.getElementById('time_text').textContent = result.duration_text;
                document.getElementById('dist_text').textContent = result.distance_km;
                document.getElementById('rush_text').textContent = result.is_rush_hour ? 'C√≥ üò´' : 'Kh√¥ng üòå';
                resultBox.classList.add('show');
                
                var group = new L.featureGroup([pickupMarker, dropoffMarker]);
                map.fitBounds(group.getBounds().pad(0.2));

            } else {
                errorBox.textContent = 'L·ªói: ' + result.detail;
                errorBox.style.display = 'block';
            }
        } catch (error) {
            loading.style.display = 'none';
            errorBox.textContent = 'L·ªói k·∫øt n·ªëi: ' + error.message;
            errorBox.style.display = 'block';
        }
    });
</script>

</body>
</html>